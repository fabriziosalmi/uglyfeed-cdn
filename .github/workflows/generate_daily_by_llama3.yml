name: Rewrite Feeds and Deploy

on:
  schedule:
    - cron: '0 7 * * *'
  workflow_dispatch:

env:
  SIMILARITY_THRESHOLD: 0.66
  MIN_SAMPLES: 2
  EPS: 0.66
  SELECTED_API: "Groq"
  GROQ_API_URL: "https://api.groq.com/openai/v1/chat/completions"
  GROQ_MODEL: "llama3-8b-8192"
  OUTPUT_FOLDER: "output"
  REWRITTEN_FOLDER: "rewritten"
  CDN_REPO: "fabriziosalmi/uglyfeed-cdn"

jobs:
  rewrite-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Check out UglyFeed repository
      uses: actions/checkout@v3
      with:
        repository: fabriziosalmi/UglyFeed
        path: UglyFeed

    - name: Override config.yaml with variables
      run: |
        cp UglyFeed/config.yaml UglyFeed/config.yaml.bak
        yq eval '.similarity_threshold = env(SIMILARITY_THRESHOLD)' -i UglyFeed/config.yaml
        yq eval '.similarity_options.min_samples = env(MIN_SAMPLES)' -i UglyFeed/config.yaml
        yq eval '.similarity_options.eps = env(EPS)' -i UglyFeed/config.yaml
        yq eval '.api_config.selected_api = env(SELECTED_API)' -i UglyFeed/config.yaml
        yq eval '.api_config.groq_api_url = env(GROQ_API_URL)' -i UglyFeed/config.yaml
        yq eval '.api_config.groq_model = env(GROQ_MODEL)' -i UglyFeed/config.yaml
        yq eval '.folders.output_folder = env(OUTPUT_FOLDER)' -i UglyFeed/config.yaml
        yq eval '.folders.rewritten_folder = env(REWRITTEN_FOLDER)' -i UglyFeed/config.yaml
        yq eval '.github_token = strenv(GENERATOR_TOKEN)' -i UglyFeed/config.yaml
        yq eval '.github_repo = env(CDN_REPO)' -i UglyFeed/config.yaml
        yq eval '.enable_github = true' -i UglyFeed/config.yaml

    - name: Debug config.yaml
      run: |
        echo "Contents of config.yaml after overriding with variables:"
        cat UglyFeed/config.yaml

        echo "Checking the eps value:"
        yq eval '.similarity_options.eps' UglyFeed/config.yaml

    - name: Overwrite input/feeds.txt
      run: |
        echo "https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml" > UglyFeed/input/feeds.txt
        echo "https://feeds.bbci.co.uk/news/rss.xml" >> UglyFeed/input/feeds.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r UglyFeed/requirements.txt

    - name: Run main.py
      run: |
        cd UglyFeed
        python main.py

    - name: Debug output contents
      run: |
        echo "Contents of the output directory after main.py execution:"
        ls -la UglyFeed/output
        echo "Attempting to display contents of output JSON files:"
        cat UglyFeed/output/*.json || echo "No JSON files found in output directory."
        if [ ! -d "UglyFeed/output" ] || [ -z "$(ls -A UglyFeed/output)" ]; then
          echo "Output directory is empty or does not exist. Check main.py execution."
          exit 1
        else
          echo "Output directory is present and contains files."
        fi

    - name: Run llm_processor.py
      run: |
        cd UglyFeed
        python llm_processor.py

    - name: Check rewritten directory
      run: |
        echo "Contents of the rewritten directory after llm_processor.py execution:"
        ls -la UglyFeed/rewritten
        if [ ! -d "UglyFeed/rewritten" ] || [ -z "$(ls -A UglyFeed/rewritten)" ]; then
          echo "Rewritten directory is empty or does not exist. Check llm_processor.py execution."
          exit 1
        else
          echo "Rewritten directory is present and contains files."
        fi

    - name: Run json2rss.py
      run: |
        cd UglyFeed
        python json2rss.py

    - name: Run deploy_xml.py
      run: |
        cd UglyFeed
        python deploy_xml.py

    - name: Deploy to feeds directory
      run: |
        mkdir -p ../uglyfeed-cdn/feeds
        cp UglyFeed/uglyfeeds/*.xml ../uglyfeed-cdn/feeds/
        cd ../uglyfeed-cdn
        git config --local user.name "fabriziosalmi"
        git config --local user.email "fabrizio.salmi@gmail.com"
        git add feeds/*.xml
        git commit -m "Deploy rewritten RSS feeds"
        git push https://x-access-token:${{ secrets.GENERATOR_TOKEN }}@github.com/${{ env.CDN_REPO }} HEAD:main
